---
layout: post
title: Set up GitHub repository and its website with RStudio
status: wait
published: false
---

```{r setup, include=FALSE}
library(nonrandom)
data("pride")
```

## Clinical problem
### Research question
* Does current infection with respiratory syncytial virus increase the risk of a severe LRTI?

### 

## Analysis

* reformat exposure and outcome
```{r}
pride$PCR_RSV <- factor(pride$PCR_RSV, levels = c(0,1), labels = c("No current RSV", "Current RSV")) 
pride$SEVERE <- factor(pride$SEVERE, levels = c(0,1), labels = c("No severe LRTI", "Severe LRTI")) 
```

### Step 1: Assess potential confounders across exposure level
* compare distributions of age, sex, tobacco across exposure level
```{r}
library(dplyr)
library(Hmisc)
with(pride, c(mean = mean(AGE), sd = sd(AGE), min = min(AGE), med = median(AGE), max = max(AGE)))
with(pride, prop.table(table(PCR_RSV, SEX), 1))
with(pride, prop.table(table(PCR_RSV, TOBACCO), 1))
```

* Why is a propensity score modelling approach suitable here?

### Step 2: Fit the propensity score model
* Fit a propensity score model including all covariates (except outcome)
```{r}
psmodel <- glm(PCR_RSV ~ AGE + SEX + as.factor(ETHNO) + FRUEHG + RSVINF + HERZ + as.factor(REGION)
                 + EINZ + TOBACCO + EXT + ELTATOP + as.factor(KRANKSUM), 
                 family = binomial(logit), data = pride)
```

* get individual propensity score
```{r}
pride$ps <-  psmodel$fitted.values
```

* Investigate propensity score distribution: consider the overlap of propensity scores in exposed and unexposed groups
```{r}
summary(pride$ps)

ggplot(pride, aes(x=ps, fill=PCR_RSV)) + geom_histogram(bins=20, alpha=.5, position="identity")
ggplot(pride, aes(PCR_RSV, ps))  + geom_boxplot()
```

### Step 3: Calculate inverse probability of treatment weights (IP(T)W) 
* Calculate IPW
```{r}
pride$ipw[as.numeric(pride$PCR_RSV) == 2] <- 1/(pride$ps[as.numeric(pride$PCR_RSV) == 2])
pride$ipw[as.numeric(pride$PCR_RSV) == 1] <- 1/(1-pride$ps[as.numeric(pride$PCR_RSV) == 1])
```

* Compare ps within the weighted sample
```{r}
ggplot(pride, aes(ps, colour = PCR_RSV, weight = ipw)) + geom_density() 
```

### Step 4: Assess the balance of covariates in the two exposure groups using standardised differences

* 
```{r}
varsToFactor <- c("SEX", "ETHNO", "FRUEHG", "RSVINF", "HERZ", "REGION", "EINZ", "TOBACCO", "EXT", "ELTATOP", "KRANKSUM")
pride[varsToFactor] <- lapply(pride[varsToFactor], factor)

vars <- c("SEX", "ETHNO", "FRUEHG", "RSVINF", "HERZ", "REGION", "EINZ", "TOBACCO", "EXT", "ELTATOP", "KRANKSUM")

library(tableone)
tab_orig <- CreateTableOne(vars=vars, strata="PCR_RSV", data=pride, test=FALSE)
```

```{r}
library(survey)
prideSVY <- svydesign(ids= ~1, data=pride, weights = ~ipw)
tab_ipw <- svyCreateTableOne(vars=vars, strata="PCR_RSV", data=prideSVY, test=FALSE)

print(tab_orig, smd=TRUE)
print(tab_ipw, smd=TRUE)
```

```{r}
pride_plot<-data.frame(variable = labels(ExtractSmd(tab_orig))[[1]],
                       original = ExtractSmd(tab_orig),
                       weighted = ExtractSmd(tab_ipw))
colnames(pride_plot) <- c("variable", "original", "weighted")
pride_plotMELT <- reshape2::melt(data=pride_plot, id.vars = c("variable"),
                       variable.name = "Method", value.name = "StDiff")

ggplot(data=pride_plotMELT, mapping = aes(x=variable, y=StDiff, 
                                          group = Method, colour=Method))  +
  geom_line() + geom_point() + coord_flip()
```

### Step 5: Calculate the risk difference between those with and without RSV 

* (a) Unadjusted

```{r}
pride$SEVEREBinary <- 0
pride$SEVEREBinary[pride$SEVERE == "Severe LRTI"] <- 1

unadj <- glm(SEVEREBinary ~ as.factor(PCR_RSV), 
             family=binomial(link="identity"), data=pride)
```

* (b) Adjusting for all potential confounders in the outcome regression model

```{r}
alladj <- glm(SEVEREBinary ~ as.factor(PCR_RSV) + AGE + SEX + as.factor(ETHNO) + FRUEHG + RSVINF + HERZ + as.factor(REGION)
                 + EINZ + TOBACCO + EXT + ELTATOP + as.factor(KRANKSUM),
            family=binomial(link=logit), data=pride)
```

* (c) Regression adjustment for propensity score

* (d) Adjusting for propensity score strata

* (e) IPW estimate

## Assessing sensitivity to unmeasured confounding

```{r}
library(twang)
data("lindner")
```

```{r}
#Generate the mortality outcome:
lindner$dead <- as.factor(lindner$sixMonthSurvive=="FALSE")


#Take a look at the exposure and the outcome:
table(lindner$abcix)
table(lindner$dead)

#1. Fit a propensity score model including all covariates 
# and generate propensity scores 

prop_model <- glm(abcix~ height+ as.factor(stent) + as.factor(female)
                  + as.factor(diabetic) + as.factor(acutemi) 
                  + ejecfrac + ves1proc, data=lindner, family=binomial)
#Generate inverse probability of treatment weights:
lindner$ps <- prop_model$fitted.values

#Investigate propensity score distribution: consider the overlap of propensity 
#scores in exposed and unexposed groups 
summary(lindner$ps)
ggplot(lindner, aes(x=ps, fill=as.factor(abcix))) + geom_histogram(bins=20, alpha=.5, position="identity")
ggplot(lindner, aes(as.factor(abcix), ps))  + geom_boxplot()


#2a. Calculate inverse probability of treatment (abciximab) 
#weights (IP(T)W) and investigate these weights, and compare estimated
#propensity scores within the weighted sample.
lindner$iptw <- lindner$abcix/lindner$ps+(1-lindner$abcix)/(1-lindner$ps)

ggplot(lindner, aes(ps, colour=as.factor(abcix),weight=iptw)) + geom_density() 


#2b. OPTIONAL Assess the balance of covariates in the two exposure groups 
#using standardised differences.

#Need to turn categorical variables to factors:
varsToFactor <- c("female", "diabetic", "acutemi", "stent")
lindner[varsToFactor] <- lapply(lindner[varsToFactor], factor)

vars <- c("stent", "height", "female", "diabetic", "acutemi",
          "ejecfrac", "ves1proc")
tab_orig <- CreateTableOne(vars=vars, strata="abcix", data=lindner, test=FALSE)

##weighted data
lindnerSVY <- svydesign(ids= ~1, data=lindner, weights = ~iptw)
tab_ipw <- svyCreateTableOne(vars=vars, strata="abcix", data=lindnerSVY, test=FALSE)

print(tab_orig, smd=TRUE)
print(tab_ipw, smd=TRUE)

#Create a nice plot
lindner_plot<-data.frame(variable = labels(ExtractSmd(tab_orig))[[1]],
                       original = ExtractSmd(tab_orig),
                       weighted = ExtractSmd(tab_ipw))
colnames(lindner_plot) <- c("variable", "original", "weighted")
lindner_plotMELT <- reshape2::melt(data=lindner_plot, id.vars = c("variable"),
                       variable.name = "Method", value.name = "StDiff")

ggplot(data=lindner_plotMELT, mapping = aes(x=variable, y=StDiff, 
                                          group = Method, colour=Method))  +
  geom_line() + geom_point() + coord_flip()

#3. Calculate the relative risk for those treated with abciximab versus those not
#a) Unadjusted:

unadj <- glm(dead ~ as.factor(abcix), 
             family=binomial(link=log), data=lindner)


#b) Adjusting for all potential confounders in the outcome regression model:
#Warning: does not converge!
#alladj <- glm(dead ~ as.factor(abcix) + as.factor(stent) + height + 
#              as.factor(female) + as.factor(diabetic) + 
#              as.factor(acutemi) + ejecfrac + ves1proc,
#              family=binomial(link=log), data=lindner)


#c) IPW estimate:
ipwadj <- glm(as.factor(dead)~as.factor(lindner$abcix), weights=iptw,
              family=binomial(link=log), data=lindner)

#4. Apply the confounding function approach.
#a) for c(0) = c(1) = 0.5
#Need to calculate h(0) = P(A=0) + c(0)P(A=1) and h(1) = P(A=0) + c(1)P(A=1)
#Note that since we account for measured confounders using IPW, we need to 
#calculate P(A=0) and P(A=1) in the weighted space.

#P(A=1) and P(A=0)
p_A1 <- weighted.mean(lindner$abcix, lindner$iptw)
p_A0 <- 1-p_A1

#Also need P(Y=1|A=0) and P(Y=1|A=1) to calculate the relative risk 
#Use the IPW regression model calculated in 3(c)
p_out <- ipwadj$fitted.values
pY_A0 <- p_out[as.factor(lindner$abcix)== 0][1]
pY_A1 <- p_out[as.factor(lindner$abcix)== 1][1]

h0 <-  p_A0 + 0.5*p_A1 
h1 <- p_A0 + 0.5*p_A1 

(h1*pY_A1/0.5)/(h0*pY_A0)
#when c(0)=c(1)=0.5, the confounding-function adjusted relative risk
#increases to 0.37. 
#c(0)=c(1)=0.5 implies that patients who are treated with abciximab are
#thought to be half as likely to die as patients treated without abciximab
#(had everyone been treated with abciximab). That is, those patients treated
#with abciximab are, on the whole, healthier than patients treated without.

#b) for c(0) = c(1) = 2 

h0 <- p_A0 + 2*p_A1 
h1 <- p_A0 + 2*p_A1 

(h1/2)*pY_A1/(h0*pY_A0)

#So when c(0)=c(1)=2, the confounding-function adjusted relative risk 	
# reduces to 0.093
#c(0)=c(1)=2 implies that patients who are treated with abciximab are
#thought to be twice as likely to die as patients treated without abciximab
#(had everyone been treated with abciximab). That is, those patients treated
#with abciximab are, on the whole, sicker than patients treated without.


#c) Verify that when c(0)=c(1)= the estimated relative risk, 
#the confounding-function adjusted relative risk is 1. 

#The observed relative risk can be calculated as:
obs_rr <- pY_A1/pY_A0
#Supposing that c(0)=c(1)=obs_rr:
h0 <- p_A0 + obs_rr*p_A1 
h1 <- p_A0 + obs_rr*p_A1 

#Verify that the confounding function-adjusted RR returned is 1:
(h1/obs_rr)*pY_A1/(h0*pY_A0)



#5. Apply the external adjustment approach to assess the impact of unmeasured 
# confounding, by finding the value of the relative risk of abciximab on an 
# unmeasured binary confounder required to return a relative risk of 1. 

#Estimated relative risk is obs_rr.

#Assuming the relative risk of unmeasured confounder on outcome is 
#equal to the relative risk of abciximab on unmeasured confounder, 
#the value required to return an adjusted RR of 1 is given by
evalue <- (1+ sqrt(1 -obs_rr))/obs_rr
#The result is 10: the observed relative risk of 0.19 could be explained
#by an unmeasured confounder that was associated with both abciximab use
#and death with a relative risk of 10 each, above the measured confounders.
#Any weaker associations could not entirely explain away this observed
#relative risk.

#The E-value of 10 implies the following bias factor:
biasfactor <-  evalue*evalue/(evalue + evalue -1)
#Check that multiplying the observed RR by this bias factor gives an 
#adjusted RR of 1:
biasfactor*obs_rr
```

